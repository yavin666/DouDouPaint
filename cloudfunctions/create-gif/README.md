# GIF生成云函数

## 当前状态：真实GIF合成版本

使用 `gif-encoder-2` 和 `canvas` 库实现真正的GIF合成功能，基于实际画布图片生成动画GIF。

## 核心功能

1. **真实图片下载**：从云存储下载前端上传的实际画布图片
2. **智能尺寸处理**：自动调整图片尺寸，保持宽高比，限制最大尺寸为500x500
3. **高质量GIF编码**：使用 gif-encoder-2 库进行专业的GIF编码
4. **动画效果**：基于多帧图片创建流畅的动画效果
5. **参数可配置**：支持自定义延迟、重复次数、质量等参数

## 技术实现

### 依赖库

```json
{
  "wx-server-sdk": "~2.6.3",    // 微信云开发SDK
  "gif-encoder-2": "^1.0.5",    // 纯JavaScript GIF编码器
  "canvas": "^2.11.2"           // Node.js Canvas库
}
```

### 核心特性

- **gif-encoder-2**：纯JavaScript实现，无原生依赖，云函数兼容性好
- **octree颜色量化**：高质量的颜色处理算法
- **透明度支持**：支持透明背景
- **循环播放**：支持无限循环或指定次数循环

## 参数说明

### 输入参数

```javascript
{
  fileIds: ["cloud://xxx.png", "cloud://yyy.png", ...], // 图片文件ID数组
  options: {
    delay: 200,      // 帧延迟(ms)，默认200
    repeat: 0,       // 重复次数，0=无限循环
    quality: 10      // 质量(1-20)，数字越小质量越高
  }
}
```

### 返回格式

```json
{
  "success": true,
  "fileID": "cloud://xxx.gif",
  "frameCount": 3,
  "fileSize": 12345,
  "fileName": "doudou_paint_xxx.gif",
  "message": "GIF生成成功"
}
```

## 处理流程

1. **参数验证**：验证输入参数的有效性
2. **图片下载**：从云存储下载所有输入图片
3. **尺寸分析**：分析第一张图片确定GIF尺寸
4. **编码器初始化**：创建GIF编码器并设置参数
5. **逐帧处理**：
   - 创建Canvas画布
   - 加载并缩放图片
   - 绘制到画布
   - 添加到GIF编码器
6. **完成编码**：生成最终的GIF数据
7. **上传存储**：将GIF上传到云存储
8. **返回结果**：返回文件ID和相关信息

## 性能优化

- **尺寸限制**：最大500x500像素，避免内存溢出
- **质量平衡**：默认质量10，平衡文件大小和视觉效果
- **错误恢复**：单帧处理失败不影响整体流程
- **内存管理**：及时释放Canvas资源

## 错误处理

- 图片下载失败：详细错误日志，继续处理其他图片
- 编码失败：返回具体错误信息
- 内存不足：自动调整参数重试
- 文件过大：限制输出文件大小

## 部署说明

1. **安装依赖**：
   ```bash
   cd cloudfunctions/create-gif
   npm install
   ```

2. **部署云函数**：
   - 通过微信开发者工具上传
   - 或使用命令行工具部署

3. **测试验证**：
   - 检查依赖是否正确安装
   - 验证GIF生成功能
   - 测试不同参数组合
